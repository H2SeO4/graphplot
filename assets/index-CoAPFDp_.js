(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function i(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(t){if(t.ep)return;t.ep=!0;const r=i(t);fetch(t.href,r)}})();const d={mode:"2d",functions:[{id:1,expression:"",color:"#d32f2f"}],functions3D:[{id:1,expression:"",color:"#d32f2f"}],nextId:2},B=["#d32f2f","#1976d2","#388e3c","#fbc02d","#8e24aa","#f57c00","#0097a7","#7b1fa2"],T=document.getElementById("function-list"),S=document.getElementById("add-btn"),F=document.getElementById("mode-btn"),V=document.getElementById("export-btn"),y=document.getElementById("plot"),D=document.getElementById("key-z"),N=document.getElementById("keyboard-toggle-btn");let L=null;function w(){window.mathVirtualKeyboard&&(window.mathVirtualKeyboard.overlay=!0),document&&document.body&&document.body.style&&(document.body.style.setProperty("padding-bottom","0px","important"),document.body.style.setProperty("margin-bottom","0px","important")),y&&(y.style.height="100%")}function K(){O(),w(),window.mathVirtualKeyboard&&typeof window.mathVirtualKeyboard.addEventListener=="function"&&window.mathVirtualKeyboard.addEventListener("geometrychange",w);const n=new MutationObserver(()=>w());document&&document.body&&n.observe(document.body,{attributes:!0,attributeFilter:["style"]}),z(),g(),S.addEventListener("click",j),F.addEventListener("click",R),V&&V.addEventListener("click",_),N&&N.addEventListener("click",()=>{window.mathVirtualKeyboard?(w(),window.mathVirtualKeyboard.visible?window.mathVirtualKeyboard.hide():(window.mathVirtualKeyboard.show(),L&&L.focus())):$("MathLive 虚拟键盘未加载，请检查网络连接。")}),window.addEventListener("resize",()=>{g()}),["math-virtual-keyboard-toggle","virtual-keyboard-toggle"].forEach(e=>{window.addEventListener(e,()=>{w(),requestAnimationFrame(()=>g())})})}function O(){const n=[];typeof functionPlot>"u"&&n.push("function-plot"),typeof math>"u"&&n.push("math.js"),typeof Plotly>"u"&&n.push("Plotly.js"),typeof MathfieldElement>"u"&&n.push("MathLive"),n.length>0&&$(`以下库加载失败: ${n.join(", ")}。请检查网络连接或刷新页面。`)}function R(){d.mode=d.mode==="2d"?"3d":"2d",F.textContent=d.mode==="2d"?"切换到 3D":"切换到 2D",D&&(D.style.display=d.mode==="2d"?"none":"block"),y.innerHTML="",z(),g()}function I(){return d.mode==="2d"?d.functions:d.functions3D}function j(){const n=I(),e=B[n.length%B.length],i={id:d.nextId++,expression:"",color:e};n.push(i),z(),setTimeout(()=>{const o=document.getElementById(`mf-${i.id}`);o&&(o.focus(),L=o)},0)}function A(n){d.mode==="2d"?d.functions=d.functions.filter(e=>e.id!==n):d.functions3D=d.functions3D.filter(e=>e.id!==n),z(),g()}function q(n,e){const o=I().find(t=>t.id===n);o&&(o.expression=e,g())}function z(){T.innerHTML="",I().forEach((e,i)=>{try{const o=document.createElement("div");o.className="function-item";const t=document.createElement("div");t.className="color-indicator",t.style.backgroundColor=e.color;const r=document.createElement("div");r.className="function-input-group";const s=document.createElement("div");s.className="input-row";const u=document.createElement("math-field");u.id=`mf-${e.id}`,u.value=e.expression,u.placeholder=d.mode==="2d"?"输入函数或方程 (如 x^2 + y^2 = 1)":"输入函数或方程 (如 z = x^2 + y^2)",u.setAttribute("math-virtual-keyboard-policy","manual");try{u.menuItems=[]}catch{}u.addEventListener("input",a=>{const f=a.target.value,p=H(f);q(e.id,p)}),u.addEventListener("focus",()=>{L=u}),s.appendChild(u),r.appendChild(s);const c=document.createElement("div");c.id=`error-${e.id}`,c.className="function-error",r.appendChild(c);const l=document.createElement("button");l.className="btn-remove",l.innerHTML="&times;",l.title="移除",l.onclick=()=>A(e.id),o.appendChild(t),o.appendChild(r),o.appendChild(l),T.appendChild(o)}catch(o){console.error("Error rendering function item:",o)}})}function C(n,e){const i=document.getElementById(`error-${n}`);i&&(i.textContent=e,i.style.display="block")}function M(n){const e=document.getElementById(`error-${n}`);e&&(e.style.display="none",e.textContent="")}function H(n){if(!n)return"";let e=n;e=e.replace(/\\mathrm{e}/g,"e"),e=e.replace(/\\exponentialE/g,"e"),e=e.replace(/\\e/g,"e"),e=e.replace(/\\cdot/g,"*"),e=e.replace(/\\times/g,"*"),e=e.replace(/\\div/g,"/"),e=e.replace(/\\pi/g,"pi"),e=e.replace(/\\theta/g,"theta"),e=e.replace(/\\sin/g,"sin"),e=e.replace(/\\cos/g,"cos"),e=e.replace(/\\tan/g,"tan"),e=e.replace(/\\ln/g,"log"),e=e.replace(/\\log(?!_)/g,"log10");let i="",o=0;for(;e!==i&&o<50;)i=e,o++,e=e.replace(/\\left\(/g,"("),e=e.replace(/\\right\)/g,")"),e=e.replace(/\\left/g,""),e=e.replace(/\\right/g,""),e=e.replace(/\\sqrt{([^{}]*)}/g,"sqrt($1)"),e=e.replace(/\\frac{([^{}]*)}{([^{}]*)}/g,"($1)/($2)"),e=e.replace(/\^{([^{}]*)}/g,"^($1)");e=e.replace(/\^([0-9])/g,"^$1");let t=0;for(;/[xyz][xyz]/.test(e)&&t<5;)e=e.replace(/([xyz])([xyz])/g,"$1*$2"),t++;return e=e.replace(/(\d)([xyz])/g,"$1*$2"),e=e.replace(/e([xyz])/g,"e*$1"),e=e.replace(/([xyz])e/g,"$1*e"),e=e.replace(/[{}]/g,""),e=e.replace(/\\/g,""),e}function g(){d.mode==="2d"?U():W()}function U(){try{const n=y.clientWidth,e=y.clientHeight,i=d.functions.filter(o=>o.expression.trim()!=="").map(o=>{M(o.id);try{let t=o.expression;if(t.includes("=")){const s=t.split("=");s.length===2&&(t=`(${s[0]}) - (${s[1]})`)}return math.parse(t),G(o.expression,o.color)}catch(t){return C(o.id,"语法错误: "+t.message),null}}).filter(o=>o!==null);i.length===0&&i.push({fn:"0",color:"transparent"}),functionPlot({target:"#plot",width:n,height:e,yAxis:{domain:[-10,10]},xAxis:{domain:[-10,10]},grid:!0,data:i,tip:{xLine:!0,yLine:!0,renderer:function(o,t,r){return`x: ${o.toFixed(3)}, y: ${t.toFixed(3)}`}}})}catch(n){console.error("2D 绘图错误:",n)}}function W(){if(typeof Plotly>"u"){$("Plotly 库未加载，无法绘制 3D 图形。请检查网络连接。");return}try{const n=[],e={autosize:!0,margin:{l:0,r:0,b:0,t:0},scene:{xaxis:{title:"x"},yaxis:{title:"y"},zaxis:{title:"z"},aspectmode:"cube"}};let i=!1;d.functions3D.forEach(o=>{if(M(o.id),!!o.expression.trim())if(o.expression.includes("="))try{const t=o.expression.split("="),r=t[0].trim(),s=t[1].trim(),u=`(${r}) - (${s})`,c=math.compile(u),l=[],a=[],f=[],p=[],m=10,x=m*2/60;for(let b=-m;b<=m;b+=x)for(let E=-m;E<=m;E+=x)for(let v=-m;v<=m;v+=x){l.push(b),a.push(E),f.push(v);try{const P=c.evaluate({x:b,y:E,z:v});p.push(typeof P=="number"?P:NaN)}catch{p.push(NaN)}}n.push({type:"isosurface",x:l,y:a,z:f,value:p,isomin:-.5,isomax:.5,surface:{show:!0,count:1,fill:.8},slices:{z:{show:!1},y:{show:!1},x:{show:!1}},caps:{x:{show:!1},y:{show:!1},z:{show:!1}},colorscale:"Viridis",showscale:!1,name:o.expression,opacity:.6}),i=!0}catch(t){console.error("3D Implicit Error",t),C(o.id,`解析错误: ${t.message}`)}else try{const t=math.compile(o.expression),r=[],s=[],u=[],c=.2,l=10;for(let a=-l;a<=l;a+=c)r.push(a);for(let a=-l;a<=l;a+=c)s.push(a);for(let a=0;a<s.length;a++){const f=[];for(let p=0;p<r.length;p++){const m={x:r[p],y:s[a]};try{const h=t.evaluate(m);typeof h=="number"&&!isNaN(h)&&isFinite(h)?f.push(h):(h&&h.re,f.push(null))}catch{f.push(null)}}u.push(f)}n.push({type:"surface",x:r,y:s,z:u,colorscale:"Viridis",name:o.expression,showscale:!1,opacity:.8}),i=!0}catch(t){console.error("3D 表达式解析错误:",t),C(o.id,`解析错误: ${t.message}`)}}),i?(Plotly.newPlot("plot",n,e,{responsive:!0,scrollZoom:!0}),Z()):Plotly.newPlot("plot",[],e,{responsive:!0,scrollZoom:!0})}catch(n){console.error("3D 绘图错误:",n),$(`绘图错误: ${n.message}`)}}function $(n){let e=document.getElementById("error-msg");e||(e=document.createElement("div"),e.id="error-msg",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.backgroundColor="rgba(255, 0, 0, 0.8)",e.style.color="white",e.style.padding="10px",e.style.borderRadius="5px",e.style.zIndex="1000",document.body.appendChild(e)),e.textContent=n,e.style.display="block"}function Z(){const n=document.getElementById("error-msg");n&&(n.style.display="none")}function _(){const i=document.createElement("canvas");i.width=800,i.height=600;const o=i.getContext("2d");o.fillStyle="#ffffff",o.fillRect(0,0,800,600),o.fillStyle="#333333",o.font="bold 20px Arial",o.fillText("GraphPlot Export",20,30);let t=60;o.font="16px Arial",I().forEach((c,l)=>{c.expression&&(o.fillStyle=c.color,o.fillText(`${d.mode==="2d"?"f":"z"}${l+1}: ${c.expression}`,20,t),t+=25)});const s=t+10,u=600-s-20;if(d.mode==="3d")Plotly.toImage(y,{format:"png",width:760,height:u}).then(function(c){const l=new Image;l.onload=function(){o.drawImage(l,20,s),k(i)},l.src=c}).catch(function(c){console.error("3D Export Error:",c),alert("导出失败: "+c.message)});else{const c=y.querySelector("svg");if(c){const l=new XMLSerializer().serializeToString(c),a=new Blob([l],{type:"image/svg+xml;charset=utf-8"}),f=URL.createObjectURL(a),p=new Image;p.onload=function(){const m=Math.min(760/p.width,u/p.height),h=p.width*m,x=p.height*m;o.drawImage(p,20,s,h,x),URL.revokeObjectURL(f),k(i)},p.src=f}else alert("未找到图表")}}function k(n){const e=document.createElement("a");e.download=`graph_export_${new Date().getTime()}.png`,e.href=n.toDataURL("image/png"),e.click()}function G(n,e){if(n=n.trim(),!n)return null;if(n.includes(",")){const t=n.split(",").map(r=>r.trim());if(t.length===2){let r=t[0].replace(/^x\s*=\s*/i,""),s=t[1].replace(/^y\s*=\s*/i,"");return{fnType:"parametric",graphType:"polyline",x:r,y:s,color:e,range:[0,2*Math.PI],nSamples:500}}}if(n.toLowerCase().startsWith("r")||n.toLowerCase().includes("theta")){let t=!1,r=n;if(r.toLowerCase().replace(/\s/g,"").startsWith("r=")?(r=r.split("=")[1].trim(),t=!0):r.toLowerCase().includes("theta")&&(t=!0),t)return{fnType:"polar",graphType:"polyline",r,color:e,range:[0,2*Math.PI],nSamples:500}}if(n.includes("=")){const t=n.split("=");if(t.length===2){const r=t[0].trim(),s=t[1].trim();return{fnType:"implicit",fn:`(${r}) - (${s})`,color:e}}}let i=n;i=i.replace(/^(y|f\(x\))\s*=\s*/i,"");const o=math.compile(i);return{fn:function(t){try{const r=typeof t=="object"&&t!==null?t.x:t;return o.evaluate({x:r})}catch{return NaN}},color:e,graphType:"polyline",nSamples:500}}K();
